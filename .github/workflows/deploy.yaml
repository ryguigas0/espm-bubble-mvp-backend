name: "Build and Deploy to Cloud Run"
run-name: ${{ github.actor }} is deploying to Cloud Run ðŸš€ (${{ github.ref }})

on:
  release:
    types: [published]

env:
  PROJECT_ID: "${{ secrets.GCP_PROJECT_ID }}"
  REGION: "${{ secrets.GCP_REGION }}"
  WORKLOAD_IDENTITY_PROVIDER: "${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}"
  SERVICE_ACCOUNT: "${{ secrets.GCP_SERVICE_ACCOUNT }}"

jobs:
  deploy:
    runs-on: 'ubuntu-latest'
    permissions:
      contents: 'read'
      id-token: 'write'
    steps:
      - name: 'Checkout'
        uses: 'actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332' # actions/checkout@v4
      - id: 'auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@f112390a2df9932162083945e46d439060d66ec2' # google-github-actions/auth@v2
        with:
          project_id: '${{ env.PROJECT_ID }}'
          workload_identity_provider: '${{ env.WORKLOAD_IDENTITY_PROVIDER }}'
          service_account: '${{ env.SERVICE_ACCOUNT }}'
      - name: 'Install Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2'
        with:
          project_id: '${{ env.PROJECT_ID }}'
          version: '>= 363.0.0'
      - name: 'Docker Auth'
        id: 'docker-auth'
        run: |-
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev
      - name: 'Build and push container'
        id: 'build-push-container'
        run: |-
          DOCKER_TAG="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ vars.GCP_SERVICE }}/backend:${{ github.sha }}"
          docker build --tag "${DOCKER_TAG}" .
          docker push "${DOCKER_TAG}"
      - name: 'Cloud Run deploy'
        id: 'deploy'
        uses: 'google-github-actions/deploy-cloudrun@33553064113a37d688aa6937bacbdc481580be17' # google-github-actions/deploy-cloudrun@v2
        with:
          service: 'backend'
          region: '${{ env.REGION }}'
          image: '${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ vars.GCP_SERVICE }}/backend:${{ github.sha }}'
          flags: '--ingress="all" --no-invoker-iam-check --min-instances=0'
          env_vars: |-
            VERSION=${{ github.sha }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            JWT_EXPIRES=${{ secrets.JWT_EXPIRES }}
            MONGO_URI=${{ secrets.MONGO_URI }}
            MONGO_AUTH_SOURCE=${{ secrets.MONGO_AUTH_SOURCE }}
      - name: 'Show Cloud Run URL'
        run: 'echo "Deploy URL: ${{ steps.deploy.outputs.url }}"'
